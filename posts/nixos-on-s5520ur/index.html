<!doctype html><html lang=en><head><title>NixOS + the Worst UEFI ever (S5520UR) :: Matthew Croughan's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="If you read the Wikipedia Page on UEFI you will notice there are a few things missing.
The first thing that is missing is names. The second is the word &amp;lsquo;engineer&amp;rsquo;. Did humans make this? Is any one responsible? Who is to blame? UEFI was designed by a comittee, so no one can be held accountable.
More digging tells me that UEFI was developed by over 140 technology companies as part of a UEFI consortium."><meta name=keywords content="linux,nixos,uefi"><meta name=robots content="noodp"><link rel=canonical href=https://blog.croughan.sh/posts/nixos-on-s5520ur/><link rel=stylesheet href=https://blog.croughan.sh/assets/style.css><link rel=stylesheet href=https://blog.croughan.sh/assets/blue.css><link rel=apple-touch-icon href=https://blog.croughan.sh/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://blog.croughan.sh/img/favicon/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="croughan.sh"><meta name=twitter:creator content="matthewcroughan"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="NixOS + the Worst UEFI ever (S5520UR)"><meta property="og:description" content="If you read the Wikipedia Page on UEFI you will notice there are a few things missing.
The first thing that is missing is names. The second is the word &amp;lsquo;engineer&amp;rsquo;. Did humans make this? Is any one responsible? Who is to blame? UEFI was designed by a comittee, so no one can be held accountable.
More digging tells me that UEFI was developed by over 140 technology companies as part of a UEFI consortium."><meta property="og:url" content="https://blog.croughan.sh/posts/nixos-on-s5520ur/"><meta property="og:site_name" content="Matthew Croughan's Blog"><meta property="og:image" content="https://blog.croughan.sh/uefi-consortium.webp"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-08-15 03:51:17 +0100 +0100"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>croughan.sh</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://blog.croughan.sh/posts/nixos-on-s5520ur/>NixOS + the Worst UEFI ever (S5520UR)</a></h1><div class=post-meta><span class=post-date>2021-08-15</span>
<span class=post-author>:: Matthew Croughan</span></div><span class=post-tags>#<a href=https://blog.croughan.sh/tags/linux/>linux</a>&nbsp;
#<a href=https://blog.croughan.sh/tags/nixos/>nixos</a>&nbsp;
#<a href=https://blog.croughan.sh/tags/uefi/>uefi</a>&nbsp;</span>
<img src=https://blog.croughan.sh/uefi-consortium.webp class=post-cover alt="NixOS + the Worst UEFI ever (S5520UR)"><div class=post-content><div><p>If you read <a href=https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface>the Wikipedia Page on
UEFI</a> you
will notice there are a few things missing.</p><p>The first thing that is missing is names. The second is the word &lsquo;engineer&rsquo;. Did
humans make this? Is any one responsible? Who is to blame? UEFI was designed by
a comittee, so no one can be held accountable.</p><p>More digging tells me that UEFI was <a href=https://uefi.org/members>developed by over 140 technology companies
as part of a UEFI consortium</a>. Is there any wonder
nobody can decide how to implement it? Especially when Facebook (!?!?) is a
member. Some BIOSes hardcode paths to <code>/EFI/Microsoft/Boot/bootmgfw.efi</code>,
probably because some of these companies only care about Windows and screwed it
up for the rest of us.</p><p>The first machine I ever ran Linux on was an Intel Server Board S5520UR. It
taught me Linux, I had no experience prior to it, it has taught me a lot of
things, but today it taught me a little bit about UEFI. Intel gets the most
credit for creating UEFI in various articles, yet this board has one of the most
broken UEFI implementations (irony?). For 3 years, I gave up trying to install
anything in EFI mode with this board, thinking it was impossible. But today, I
decided I wasn&rsquo;t content with that, so went on an 8 hour mission, mostly due to
the time it takes to POST!</p><p>Some facts:</p><ul><li>The board takes 2 minutes to initialize and POST, which is much longer than it takes
to boot Linux.</li><li>Cost me only Â£50 from eBay.</li><li>Is probably not worth the effort, but whatever.</li></ul><h1 id=the-problem>The problem<a href=#the-problem class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Attempts to install any OS in EFI mode results in the BIOS of the S5520UR
seemingly being unable to see the <code>.efi</code> file on the disk, meaning you can&rsquo;t
really boot anything if you try, since it won&rsquo;t show up in the Boot Menu or Boot
Manager of the BIOS.</p><p>For some reason, the NixOS Installer Media shows up in the BIOS as <code>EFI:Corsair Voyager SliderX2000AHD(Part1,Sig9FB6382F</code> which is correct. I can&rsquo;t replicate
this behavior via the installation of any OS. Only this installer media seems to
have the correct configuration to be auto-detected by the S5520UR&rsquo;s UEFI
implementation when flashed to a USB flash drive.</p><p>Upon a quick Google you can <a href=https://www.reddit.com/r/servers/comments/ar3k6y/trying_to_install_windows_to_an_intel_s5520ur/>this post on
Reddit</a>
entitled <em>&ldquo;Trying to install Windows to an Intel S5520UR board with RAID0 SAS
array. Gets stuck on &ldquo;Copying files (0%)&rdquo;. Help?"</em></p><blockquote><p>I was able to fix the problem. <strong>Don&rsquo;t try to install Windows in EFI mode only</strong>,
this causes the freeze. I guess these kind of servers are just too old.</p></blockquote><p>They also gave up. Unacceptable.</p><p>So, what can it be? I happen to be trying to install NixOS, which gives me an
advantage in both trying out various bootloader configurations and explaining
what I tried.</p><h1 id=first-attempts>First attempts<a href=#first-attempts class=hanchor arialabel=Anchor>&#8983;</a></h1><p>First, I try systemd-boot:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>{
  boot<span style=color:#f92672>.</span>loader<span style=color:#f92672>.</span>systemd-boot<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
}
</code></pre></div><p><a href=https://www.dictionary.com/browse/nix>Nix</a>. The disk does not appear as a bootable device in the BIOS.</p><p>What about systemd-boot, but this time giving it the ability to touch variables in
<code>/sys/firmware/efi/efivars/</code>?</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>{
  boot<span style=color:#f92672>.</span>loader <span style=color:#f92672>=</span> {
    systemd-boot<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
    canTouchEfiVariables <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
  };
}
</code></pre></div><p>This halts the CPU. So what about GRUB?</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>{
  boot<span style=color:#f92672>.</span>loader <span style=color:#f92672>=</span> {
    efi <span style=color:#f92672>=</span> {
      canTouchEfiVariables <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
    };
    grub <span style=color:#f92672>=</span> {
       efiSupport <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
       device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nodev&#34;</span>;
    };
  };
}
</code></pre></div><p>The same result. No <code>EFI:&lt;disk></code> option in the BIOS for the installation. The
CPU still halts if <code>boot.loader.efi.canTouchEfiVariables = true;</code></p><p>I saw <a href=https://nixos.wiki/wiki/Bootloader#Wrangling_recalcitrant_UEFI_implementations>this
section</a>
of the nixos.wiki on &ldquo;Wrangling recalcitrant UEFI implementations&rdquo; and decided
to try and copy the <code>.efi</code> file for systemd-boot from
<code>/boot/EFI/systemd/systemd-bootx64.efi</code> to <code>/EFI/Microsoft/Boot/bootmgfw.efi</code>. I
was quite smug and hopeful about this one, but still, it did not work. But it
would have been an awesome hack if it did.</p><h1 id=refind>rEFInd<a href=#refind class=hanchor arialabel=Anchor>&#8983;</a></h1><p>The NixOS installer comes with a tool called rEFInd when booted in EFI mode. If
I select and use it, it successfully detects my previous attempts, be it GRUB or
systemd-boot, and successfully allows me to boot those bootloaders in EFI mode.
Now it&rsquo;s getting interesting.</p><h1 id=getting-closer>Getting Closer<a href=#getting-closer class=hanchor arialabel=Anchor>&#8983;</a></h1><p>There is a section in the nixos.wiki that mentions an interesting option that
I&rsquo;ve never seen before, called <code>boot.loader.grub.efiInstallAsRemovable</code>. I
decide to try it out, but I still get the same result. However, I find <a href=https://github.com/NixOS/nixpkgs/pull/35528>this
pull request</a> from NixOS
contributor &lsquo;samueldr&rsquo; which reiterates some of my issues with EFI boot. I
believed it was possible that this option might have some impact on it.</p><p>I waste no time. I enter the NixOS Matrix Channel and tag @samueldr and describe
the issue exactly. He informs me that that pull request has nothing to do with
my problem, but that my UEFI implementation is buggy if this doesn&rsquo;t work as a
&ldquo;fallback&rdquo;. It turns out that all UEFI implementations should fallback to a
default EFI program when present; which in this case should be the GRUB I just
installed with <code>efiInstallAsRemovable = true;</code>.</p><h1 id=epiphany>Epiphany<a href=#epiphany class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Finally. We discover that there is an option in the BIOS named &ldquo;Add new boot
option&rdquo;. It turns out that this must be manually invoked and passed an absolute
path to the location of the <code>.efi</code> file on disk if you ever hope to boot
anything with EFI.</p><table><thead><tr><th>Step 1</th><th>Step 2</th></tr></thead><tbody><tr><td><img src=/uefi-bios1.webp alt></td><td><img src=/uefi-bios2.webp alt></td></tr></tbody></table><p>So I do it, I label it <code>maybe-nixos</code>, I give it a path to the <code>.efi</code> file
<code>\efi\boot\bootx64.efi</code>. Then, I try to boot it. It boots without the
assistance of rEFInd.</p><h1 id=takeaway>Takeaway<a href=#takeaway class=hanchor arialabel=Anchor>&#8983;</a></h1><p>S5520UR:</p><ul><li>Won&rsquo;t use fallback locations</li><li>Halts the CPU when <code>/sys/firmware/efi/efivars/</code> is poked</li><li>Apparently requires completely manual setup and configuration of the EFI boot via human fingers</li><li>Is hot trash.</li></ul><p>The only documentation I can find for this that could possibly help a normal
user of the motherboard is buried in the <a href=https://techlibrary.hpe.com/docs/iss/proliant_uefi/UEFI_TM_030617/s_adding_boot_option.html>Aptio HPE
documentation</a></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://blog.croughan.sh/posts/lustrating-arch/><span class=button__text>Lustrating My Frustrating Arch Install (De-Antergosifying)</span>
<span class=button__icon>â</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://blog.croughan.sh/assets/main.js></script><script src=https://blog.croughan.sh/assets/prism.js></script></div></body></html>